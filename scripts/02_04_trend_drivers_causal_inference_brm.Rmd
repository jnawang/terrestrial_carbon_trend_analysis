---
title: "identify trend drivers using causal inference"
output: pdf_document
date: "2025-04-08"
author: "Junna Wang"
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```


```{r raw data location}
rm(list=ls())
# change this location where the raw data will be saved accordingly
# dir_rawdata <- '/Users/jw2946/Documents/stability_project/SiteData/'
dir_rawdata <- '/Volumes/MaloneLab/Research/Stability_Project/SiteData'
#
library(librarian)
shelf(tidyverse, ggpubr, lme4, dagitty, lmerTest, brms)
#
```


```{r read data}
#-------------------------------------------------------------------------------
sub_time_series <- read.csv("data/sub_time_series_potential_drivers_sen.csv")
sites_long <- read.csv('data/long_term_ec_sites.csv')
if (! "category" %in% names(sub_time_series)) {
  sub_time_series <- sub_time_series %>% 
    left_join(sites_long[, c("site_ID", "category")], by="site_ID") %>%
    rename("NEE_trend"="NEEtrend_lm")
}

data <- sub_time_series %>% 
  dplyr::select(c("NEE_trend", "TA_t", "TA_gs_t", "TA_ngs_t", "P_t", "P_gs_t", "P_ngs_t", 
           "VPD_gs_t", "VPD_ngs_t", 
           "SW_t", "SW_gs_t", "SW_ngs_t", "LE_t", "LE_gs_t", "LE_ngs_t", "Lgs_t", 
           "MAT", "MAP", "Height", "Age", "Nmean", "CO2_t", "IGBP", "category", "site_ID"))


df_total_effect <- data.frame(climate_veg = character(), exposure = character(), outcome = character(), effect_type = character(), 
                              estimate = double(), ci_lower_2.5 = double(), ci_lower_5 = double(), ci_upper_95 = double(), ci_upper_97.5 = double(), 
                              formula = character())

df_direct_effect <- df_total_effect

```


```{r a function to calculate direct and total effects based on DAG}
options(mc.cores = parallel::detectCores())
#
run_adjusted_model <- function(
  dag,
  exposure,
  outcome,
  data,
  group_vars = NULL,
  priors = NULL,
  backend = "cmdstanr",
  iter = 4000,
  adapt_delta = 0.99,
  max_treedepth = 10, 
  effect_type = c("direct", "total")
) {
  effect_type <- match.arg(effect_type)

  # Determine adjustment set
  if (effect_type == "direct") {
    adjustment_set <- adjustmentSets(dag, exposure = exposure, outcome = outcome, type = c("minimal"), effect = c("direct"))
  } else if (effect_type == "total") {
    adjustment_set <- adjustmentSets(dag, exposure = exposure, outcome = outcome, type = c("minimal"), effect = "total")
  }

  if (length(adjustment_set) == 0) {
    message(paste("No adjustment set found for ", effect_type, " effect:", exposure, "→", outcome))
    adjust_vars <- character(0)
  } else {
    adjust_vars <- unlist(adjustment_set[[1]])
    message(paste("Adjustment set found for ", effect_type, " effect:", exposure, "→", outcome, "  ", adjustment_set[[1]]))
  }
  
  rhs_terms <- paste(c(exposure, adjust_vars), collapse = " + ")
  formula_str <- paste(outcome, "~", rhs_terms)

  # Add random effects if specified
  if (!is.null(group_vars)) {
    group_terms <- paste0("(1|", group_vars, ")", collapse = " + ")
    formula_str <- paste(formula_str, "+", group_terms)
  }
  message(formula_str)
  
  # Fit the model
  fit <- brm(
    formula = as.formula(formula_str),
    data = data,
    prior = priors,
    backend = backend,
    iter = iter,
    control = list(adapt_delta = adapt_delta, max_treedepth = max_treedepth),
    silent = TRUE
  )

  print(summary(fit))
  # Extract coefficient summary with additional quantiles
  summary_fit <- posterior_summary(fit, probs = c(0.025, 0.05, 0.95, 0.975))
  coef_name <- paste0("b_", exposure)
#  browser()
  
  if (!(coef_name %in% rownames(summary_fit))) {
    stop(paste("Coefficient", coef_name, "not found in model summary"))
  }

  coef_row <- summary_fit[coef_name, ]

  result <- data.frame(
    exposure = exposure,
    outcome = outcome,
    effect_type = effect_type,
    estimate = coef_row["Estimate"],
    ci_lower_2.5 = coef_row["Q2.5"],
    ci_lower_5 = coef_row["Q5"],
    ci_upper_95 = coef_row["Q95"],
    ci_upper_97.5 = coef_row["Q97.5"],
    formula = formula_str
  )

  rownames(result) <- NULL
  return(result)
}

```


```{r Evergreen forests in cold climate}

DAG_cold_forest <- dagitty("dag {
  Age -> NEE_trend
  Age -> Height -> NEE_trend
  TA_gs_t -> LE_gs_t <- P_gs_t
  TA_gs_t -> NEE_trend
  P_gs_t -> NEE_trend
  LE_gs_t -> NEE_trend
  TA_gs_t -> Lgs_t -> NEE_trend
  Height -> LE_gs_t
  Height -> Lgs_t
  P_gs_t -> Lgs_t
  SW_gs_t -> NEE_trend
  P_gs_t -> SW_gs_t
  SW_gs_t -> TA_gs_t
  SW_gs_t -> LE_gs_t
  SW_gs_t -> Lgs_t
  Age -> SW_gs_t
}")


plot(graphLayout(DAG_cold_forest))
#----------------------------------------------
data_cold_ENF_noAge <- data %>% 
  filter(IGBP %in% c('ENF', 'EBF') & category == "cold") %>% 
  dplyr::select(-c("category", "P_t", "SW_t", "LE_t"))

data_cold_ENF <- data %>% 
  filter(IGBP %in% c('ENF', 'EBF') & category == "cold") %>% 
  dplyr::select(-c("category", "P_t", "SW_t", "LE_t")) %>% filter(!is.na(Age) & !is.na(Lgs_t))

data_cold_ENF_DAG <- data_cold_ENF %>% dplyr::select(-c("IGBP", "site_ID"))

r <- localTests(x = DAG_cold_forest, data=data_cold_ENF_DAG, type='cis', abbreviate.names = F)
plotLocalTestResults(r)
print(subset(r, p.value < 0.05))

#-------------------------------------------------------------------------------
for (i in 1:ncol(data_cold_ENF)) {
  if (!names(data_cold_ENF)[i] %in% c('IGBP', "site_ID")) {
    data_cold_ENF[, i] <- scale(data_cold_ENF[, i])
  }
}

#-------------------------------------------------------------------------------
# set priors
priors <- c(
  prior(normal(0.5, 0.5), class = "sd", lb = 0),    # Stronger prior for group-level SDs
  prior(normal(0.5, 0.1), class = "sigma", lb = 0)  # For residual error, this prior is confident
)
# call functions
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "LE_gs_t", outcome = "NEE_trend", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "P_gs_t", outcome = "NEE_trend", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "TA_gs_t", outcome = "NEE_trend", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "SW_gs_t", outcome = "NEE_trend", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "Lgs_t", outcome = "NEE_trend", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "Height", outcome = "NEE_trend", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "Age", outcome = "NEE_trend", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
# direct effects on other variables
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "Age", outcome = "Height", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "Height", outcome = "Lgs_t", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "Height", outcome = "LE_gs_t", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "TA_gs_t", outcome = "LE_gs_t", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "P_gs_t", outcome = "LE_gs_t", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "SW_gs_t", outcome = "LE_gs_t", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "P_gs_t", outcome = "Lgs_t", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "SW_gs_t", outcome = "Lgs_t", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "TA_gs_t", outcome = "Lgs_t", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "P_gs_t", outcome = "SW_gs_t", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "SW_gs_t", outcome = "TA_gs_t", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "Age", outcome = "SW_gs_t", effect_type = "direct", 
                   data = data_cold_ENF_noAge, group_vars = "site_ID", priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))

#------------------------------------------------------------------------------------------------
#--------------------calculate total effect size of each driver----------------------------------
exposure_vars <- c("P_gs_t", "Lgs_t", "SW_gs_t", "LE_gs_t", "TA_gs_t", "Height", "Age")
for (exposure_var in exposure_vars) {
  r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = exposure_var, outcome = "NEE_trend", effect_type = "total", 
                   data = data_cold_ENF_noAge, group_vars = c("site_ID"), priors = priors)
  df_total_effect <- rbind(df_total_effect, data.frame(climate_veg = 'wet_cold_ENF', r1))
}

#------------------------------------------------------------------------------------------------
#------------------------------------------------Making plots------------------------------------
ggplot(data=data_cold_ENF, aes(x=P_gs_t, y=NEE_trend, col=IGBP)) + 
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor(color='red')

ggplot(data=data_cold_ENF, aes(x=Lgs_t, y=NEE_trend, col=IGBP)) + 
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor(color='red')

ggplot(data=data_cold_ENF, aes(x=Age, y=NEE_trend, col=IGBP)) + 
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor(color='red')

```


```{r cold DBF and MF}
data_cold_DBF_MF_noAge <- data %>% 
  filter(IGBP %in% c("MF", "DBF") & category == "cold") %>%  # "DBF", "MF"
  dplyr::select(-c("category", "P_t", "SW_t", "LE_t"))

data_cold_DBF_MF <- data %>% 
  filter(IGBP %in% c("MF", "DBF") & category == "cold") %>%  # "DBF", "MF"
  dplyr::select(-c("category", "P_t", "SW_t", "LE_t")) %>% filter(!is.na(Age) & !is.na(Lgs_t))

data_cold_DBF_MF_DAG <- data_cold_DBF_MF %>% dplyr::select(-c("IGBP", "site_ID"))

r <- localTests(x = DAG_cold_forest, data=data_cold_DBF_MF_DAG, type='cis', abbreviate.names = F)
plotLocalTestResults(r)
print(subset(r, p.value < 0.05))
#------------------------------------------------------------------------------- 

for (i in 1:ncol(data_cold_DBF_MF)) {
  if (!names(data_cold_DBF_MF)[i] %in% c('IGBP', 'site_ID')) {
    data_cold_DBF_MF[, i] <- scale(data_cold_DBF_MF[, i])
  }
}

ggplot(data=data_cold_DBF_MF, aes(y=NEE_trend, x=IGBP)) + 
  geom_boxplot()
#-------------------------------------------------------------------------------
# set priors
priors <- c(
  prior(normal(0.5, 0.5), class = "sd", lb = 0)    # Stronger prior for group-level SDs
)
# call functions
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "LE_gs_t", outcome = "NEE_trend", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "P_gs_t", outcome = "NEE_trend", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "TA_gs_t", outcome = "NEE_trend", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "SW_gs_t", outcome = "NEE_trend", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "Lgs_t", outcome = "NEE_trend", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "Height", outcome = "NEE_trend", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "Age", outcome = "NEE_trend", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))

#---------------------------------------direct effects on other variables----------------------------------
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "Age", outcome = "Height", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = prior(normal(0.5, 0.1), class = "sd", lb = 0))
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "TA_gs_t", outcome = "LE_gs_t", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "P_gs_t", outcome = "LE_gs_t", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "SW_gs_t", outcome = "LE_gs_t", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "Height", outcome = "LE_gs_t", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "Height", outcome = "Lgs_t", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "P_gs_t", outcome = "Lgs_t", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "SW_gs_t", outcome = "Lgs_t", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "TA_gs_t", outcome = "Lgs_t", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "P_gs_t", outcome = "SW_gs_t", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "SW_gs_t", outcome = "TA_gs_t", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = "Age", outcome = "SW_gs_t", effect_type = "direct", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
#
#------------------------------------------------------------------------------------------------
#--------------------calculate total effect size of each driver----------------------------------
exposure_vars <- c("LE_gs_t", "Age", "TA_gs_t", "Lgs_t", "SW_gs_t", "P_gs_t", "Height")
for (exposure_var in exposure_vars) {
  r1 <- run_adjusted_model(dag = DAG_cold_forest, exposure = exposure_var, outcome = "NEE_trend", effect_type = "total", 
                   data = data_cold_DBF_MF, group_vars = c("IGBP", "site_ID"), priors = priors)
  df_total_effect <- rbind(df_total_effect, data.frame(climate_veg = 'wet_cold_DBF_MF', r1))
}

#----------------------------------------------------------------------
####I should use a different way to plot the two figures!
ggplot(data=data_cold_DBF_MF, aes(x=LE_gs_t, y=NEE_trend, col=IGBP)) + 
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor(color='purple')

ggplot(data=data_cold_DBF_MF, aes(x=P_gs_t, y=NEE_trend, col=IGBP)) + 
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor(color='purple')


####use the same slope but different intercept. 
ggplot(data=data_cold_DBF_MF, aes(x=Age, y=NEE_trend, col=IGBP)) + 
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor(color='purple')

```


```{r cold and nonforest}
DAG_cold_nonforest <- dagitty("dag {
  TA_gs_t -> LE_gs_t <- P_gs_t
  TA_gs_t -> NEE_trend
  P_gs_t -> NEE_trend
  LE_gs_t -> NEE_trend
  TA_gs_t -> Lgs_t -> NEE_trend
  Height -> NEE_trend
  Height -> LE_gs_t
  Height -> Lgs_t
  P_gs_t -> Lgs_t
  SW_gs_t -> NEE_trend
  P_gs_t -> SW_gs_t
  SW_gs_t -> TA_gs_t
  SW_gs_t -> LE_gs_t
  SW_gs_t -> Lgs_t
}")

plot(graphLayout(DAG_cold_nonforest))

data_cold_nonforest <- data %>% filter(category == "cold") %>%
  filter(!IGBP %in% c("DBF", "MF", "ENF", "EBF")) %>%  # , "MF"
  dplyr::select(-c("category", "P_t", "SW_t", "LE_t", "Age")) # %>% filter(!is.na(Lgs_t)) 
# %>% filter(site_ID !='BE-Maa')

data_cold_nonforest_DAG <- data_cold_nonforest %>% dplyr::select(-c("IGBP", "site_ID"))

r <- localTests(x = DAG_cold_nonforest, data=data_cold_nonforest_DAG, type='cis', abbreviate.names = F)
plotLocalTestResults(r)
print(subset(r, p.value < 0.05))

summary(aov(data=data_cold_nonforest, NEE_trend ~ IGBP))
#             Df Sum Sq Mean Sq F value  Pr(>F)   
# IGBP         3 0.1704 0.05679   3.752 0.0266 *
# Residuals   21 0.3178 0.01513
#----------------------------------------------------------------------------------
for (i in 1:ncol(data_cold_nonforest)) {
  if (!names(data_cold_nonforest)[i] %in% c('IGBP', 'site_ID')) {
    data_cold_nonforest[, i] <- scale(data_cold_nonforest[, i])
  }
}
#--------------
# get all the direct effects
edges <- edges(DAG_cold_nonforest)
direct_effects <- data.frame(from = edges$v, to = edges$w)

# set priors
priors <- c(
  prior(normal(0.5, 0.5), class = "sd", lb = 0),  # Stronger prior for group-level SDs
  prior(normal(0.5, 0.1), class = "sigma", lb = 0)  # For residual error, this prior is confident
)

# call functions
for (i in 1:nrow(direct_effects)) {
  r1 <- run_adjusted_model(dag = DAG_cold_nonforest, exposure = direct_effects$from[i], outcome = direct_effects$to[i], effect_type = "direct", 
                           data = data_cold_nonforest, group_vars = c("IGBP", "site_ID"), priors = priors)
  df_direct_effect <- rbind(df_direct_effect, data.frame(climate_veg = 'wet_cold_nonforest', r1))
}





adjustmentSets(
x = DAG_cold_nonforest,
exposure = "LE_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
)  # { P_gs_t, TA_gs_t, Height, SW_gs_t}


fit <- brm(data=data_cold_nonforest, NEE_trend ~ LE_gs_t + P_gs_t + TA_gs_t + Height + SW_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=4000, control = list(adapt_delta = 0.99, max_treedepth = 20))
r1 <- summary(fit) 
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_cold_nonforest,
exposure = "SW_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
) # { Height, LE_gs_t, Lgs_t, P_gs_t, TA_gs_t }
# use the below results

adjustmentSets(
x = DAG_cold_nonforest,
exposure = "P_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
)  # { Height, LE_gs_t, Lgs_t, TA_gs_t, SW_gs_t }
# use the below results

adjustmentSets(
x = DAG_cold_nonforest,
exposure = "TA_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
) # { Height, LE_gs_t, Lgs_t, P_gs_t, SW_gs_t }

fit <- brm(data=data_cold_nonforest, NEE_trend ~ SW_gs_t + P_gs_t + TA_gs_t + Height + Lgs_t + LE_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=4000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr")
posterior_interval(fit, prob = 0.9)["b_P_gs_t", ]
r1 <- summary(fit)
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[3], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[3,1], es_min = r1$fixed[3,3], es_max = r1$fixed[3,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[4], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[4,1], es_min = r1$fixed[4,3], es_max = r1$fixed[4,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[5], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[5,1], es_min = r1$fixed[5,3], es_max = r1$fixed[5,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_cold_nonforest,
exposure = "Height",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
) # { LE_gs_t, Lgs_t, P_gs_t, TA_gs_t, SW_gs_t }
# use the above results 

adjustmentSets(
x = DAG_cold_nonforest,
exposure = "Lgs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
) # { Height, P_gs_t, SW_gs_t, TA_gs_t }

r1 <- summary(brm(data=data_cold_nonforest, NEE_trend ~ Lgs_t + Height + P_gs_t + SW_gs_t + TA_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=4000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

#---------------------------------------------------------------------------------

adjustmentSets(
x = DAG_cold_nonforest,
exposure = "Height",
outcome = "LE_gs_t",
type = c("minimal"),
effect = c("direct")
) # { }
r1 <- summary(brm(data=data_cold_nonforest, LE_gs_t ~ Height + (1|IGBP) + (1|site_ID), prior=priors, iter=4000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_cold_nonforest,
exposure = "TA_gs_t",
outcome = "LE_gs_t",
type = c("minimal"),
effect = c("direct")
) # { SW_gs_t }

r1 <- summary(brm(data=data_cold_nonforest, LE_gs_t ~ TA_gs_t + SW_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=4000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

 
adjustmentSets(
x = DAG_cold_nonforest,
exposure = "P_gs_t",
outcome = "LE_gs_t",
type = c("minimal"),
effect = c("direct")
)  # {SW_gs_t}
r1 <- summary(brm(data=data_cold_nonforest, LE_gs_t ~ P_gs_t + SW_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=4000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_cold_nonforest,
exposure = "SW_gs_t",
outcome = "LE_gs_t",
type = c("minimal"),
effect = c("direct")
) # { P_gs_t, TA_gs_t }
r1 <- summary(brm(data=data_cold_nonforest, LE_gs_t ~ SW_gs_t + P_gs_t + TA_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=4000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

#-----------------------------
adjustmentSets(
x = DAG_cold_nonforest,
exposure = "P_gs_t",
outcome = "Lgs_t",
type = c("minimal"),
effect = c("direct")
) # { SW_gs_t }
r1 <- summary(brm(data=data_cold_nonforest, Lgs_t ~ P_gs_t + SW_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=4000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_cold_nonforest,
exposure = "SW_gs_t",
outcome = "Lgs_t",
type = c("minimal"),
effect = c("direct")
) # { P_gs_t, TA_gs_t }
r1 <- summary(brm(data=data_cold_nonforest, Lgs_t ~ SW_gs_t + P_gs_t + TA_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=4000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

adjustmentSets(
x = DAG_cold_nonforest,
exposure = "TA_gs_t",
outcome = "Lgs_t",
type = c("minimal"),
effect = c("direct")
) # { SW_gs_t }
r1 <- summary(brm(data=data_cold_nonforest, Lgs_t ~ TA_gs_t + SW_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=4000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_cold_nonforest,
exposure = "Height",
outcome = "Lgs_t",
type = c("minimal"),
effect = c("direct")
) # { }
r1 <- summary(brm(data=data_cold_nonforest, Lgs_t ~ Height + (1|IGBP) + (1|site_ID), prior=priors, iter=4000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_cold_nonforest,
exposure = "P_gs_t",
outcome = "SW_gs_t",
type = c("minimal"),
effect = c("direct")
) # {}

r1 <- summary(brm(data=data_cold_nonforest, SW_gs_t ~ P_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=4000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

#------------

adjustmentSets(
x = DAG_cold_nonforest,
exposure = "SW_gs_t",
outcome = "TA_gs_t",
type = c("minimal"),
effect = c("direct")
) # {}
r1 <- summary(brm(data=data_cold_nonforest, TA_gs_t ~ SW_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=4000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet_cold_nonforest', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


#------------------------------------------------------------------------------------------------
#--------------------calculate total effect size of each driver----------------------------------
adjustmentSets(
x = DAG_cold_nonforest,
exposure = "Height",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
) # {  }
r1 <- summary(brm(data=data_cold_nonforest, NEE_trend ~ Height + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1

df <- data.frame(climate_veg = 'wet_cold_nonforest', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)


adjustmentSets(
x = DAG_cold_nonforest,
exposure = "P_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
) # {}
r1 <- summary(brm(data=data_cold_nonforest, NEE_trend ~ P_gs_t + (1|IGBP) + (1|site_ID), iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))  # prior=priors, 
r1
df <- data.frame(climate_veg = 'wet_cold_nonforest', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)


adjustmentSets(
x = DAG_cold_nonforest,
exposure = "LE_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
) # {Height, P_gs_t, SW_gs_t, TA_gs_t}
r1 <- summary(brm(data=data_cold_nonforest, NEE_trend ~ LE_gs_t + Height + P_gs_t + SW_gs_t + TA_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1

df <- data.frame(climate_veg = 'wet_cold_nonforest', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)


adjustmentSets(
x = DAG_cold_nonforest,
exposure = "TA_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
) # { SW_gs_t }
r1 <- summary(brm(data=data_cold_nonforest, NEE_trend ~ TA_gs_t + SW_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1

df <- data.frame(climate_veg = 'wet_cold_nonforest', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)

adjustmentSets(
x = DAG_cold_nonforest,
exposure = "SW_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
) # { P_gs_t }
r1 <- summary(brm(data=data_cold_nonforest, NEE_trend ~ SW_gs_t + P_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1

df <- data.frame(climate_veg = 'wet_cold_nonforest', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)


adjustmentSets(
x = DAG_cold_nonforest,
exposure = "Lgs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
) # { Height, P_gs_t, SW_gs_t, TA_gs_t }

r1 <- summary(brm(data=data_cold_nonforest, NEE_trend ~ Height + P_gs_t + SW_gs_t + TA_gs_t + Lgs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1


#----------------------------------------------------------------------
####I should use a different way to plot the two figures!
ggplot(data=data_cold_nonforest, aes(x=P_gs_t, y=NEE_trend, col=IGBP)) + 
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor()

####use the same slope but different intercept. 
ggplot(data=data_cold_nonforest, aes(x=Height, y=NEE_trend)) +   # , col=IGBP
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor(color='purple')

ggplot(data=data_cold_nonforest, aes(x=SW_gs_t, y=NEE_trend, col=IGBP)) +   # , col=IGBP
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor()



```


```{r dry climate}
#-----construct DAG
DAG_dry <- dagitty("dag {
  TA_gs_t -> VPD_gs_t <- P_gs_t
  TA_gs_t -> NEE_trend
  P_gs_t -> NEE_trend
  VPD_gs_t -> NEE_trend
  TA_ngs_t -> NEE_trend
  P_ngs_t -> NEE_trend
  TA_ngs_t -> VPD_ngs_t <- P_ngs_t
  VPD_ngs_t -> NEE_trend
  Lgs_t -> NEE_trend
  Height -> NEE_trend
  Height -> TA_gs_t
  SW_gs_t -> NEE_trend
  SW_gs_t -> VPD_gs_t
  SW_gs_t -> TA_gs_t
  SW_ngs_t -> NEE_trend
  SW_ngs_t -> VPD_ngs_t
  SW_ngs_t -> TA_ngs_t
}")
plot(graphLayout(DAG_dry))
  #  
  # SW_gs_t -> VPD_ngs_t  ; removed!! 
  # VPD_ngs_t -> Lgs_t
  # TA_ngs_t -> Lgs_t 
  # SW_ngs_t -> Lgs_t
  # VPD_gs_t -> VPD_ngs_t
  # TA_gs_t -> P_gs_t

#----Test model-data consistency
data_dry <- data %>% 
  filter(category == "dry") %>% 
  dplyr::select(-c("category", "P_t", "SW_t", "LE_t", "Age"))  %>% filter(!is.na(Lgs_t))

data_dry_DAG <- data_dry %>% dplyr::select(-c("IGBP", "site_ID"))

r <- localTests(x = DAG_dry, data=data_dry_DAG, type='cis', abbreviate.names = F)
plotLocalTestResults(r)
print(subset(r, p.value < 0.05))

#----calculate direct effect
# scale all the variables using Z score
for (i in 1:ncol(data_dry)) {
  if (!names(data_dry)[i] %in% c('IGBP', 'site_ID')) {
    data_dry[, i] <- scale(data_dry[, i])
  }
}

####what variables to condition on?
adjustmentSets(
x = DAG_dry,
exposure = "VPD_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
)  # { P_gs_t, SW_gs_t, TA_gs_t}

priors <- c(
  prior(normal(0.5, 0.5), class = "sd", lb = 0),  # Stronger prior for group-level SDs
  prior(normal(0.5, 0.1), class = "sigma", lb = 0)  # For residual error, this prior is confident
)
r1 <- summary(brm(data=data_dry, NEE_trend ~ VPD_gs_t + SW_gs_t + P_gs_t + TA_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_dry,
exposure = "SW_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
) # { Height, P_gs_t, TA_gs_t, VPD_gs_t}
r1 <- summary(brm(data=data_dry, NEE_trend ~ SW_gs_t + Height + P_gs_t + TA_gs_t + VPD_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_dry,
exposure = "P_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
)  # {SW_gs_t, TA_gs_t, VPD_gs_t } 
r1 <- summary(brm(data=data_dry, NEE_trend ~ P_gs_t + SW_gs_t + VPD_gs_t + TA_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_dry,
exposure = "TA_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
)  # { Height, P_gs_t, SW_gs_t, VPD_gs_t } 
r1 <- summary(brm(data=data_dry, NEE_trend ~ TA_gs_t + VPD_gs_t + P_gs_t + SW_gs_t + Height + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


summary(aov(data=data_dry, NEE_trend ~ IGBP))
# IGBP         7  8.392  1.1988   1.418  0.306
# Residuals    9  7.608  0.8453    

adjustmentSets(
x = DAG_dry,
exposure = "Height",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
)  # { SW_gs_t, TA_gs_t }
r1 <- summary(brm(data=data_dry, NEE_trend ~ Height + SW_gs_t + TA_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_dry,
exposure = "Height",
outcome = "TA_gs_t",
type = c("minimal"),
effect = c("direct")
) # {}
r1 <- summary(brm(data=data_dry, TA_gs_t ~ Height + (1|IGBP) + (1|site_ID), iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_dry,
exposure = "Lgs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
) # { }
r1 <- summary(brm(data=data_dry, NEE_trend ~ Lgs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

adjustmentSets(
x = DAG_dry,
exposure = "SW_ngs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
) # { P_ngs_t, TA_ngs_t, VPD_ngs_t }        
r1 <- summary(brm(data=data_dry, NEE_trend ~ SW_ngs_t + P_ngs_t + TA_ngs_t + VPD_ngs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

adjustmentSets(
x = DAG_dry,
exposure = "VPD_ngs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
) # { P_ngs_t, SW_ngs_t, TA_ngs_t}
r1 <- summary(brm(data=data_dry, NEE_trend ~ VPD_ngs_t + TA_ngs_t + P_ngs_t + SW_ngs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[3], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[3,1], es_min = r1$fixed[3,3], es_max = r1$fixed[3,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[4], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[4,1], es_min = r1$fixed[4,3], es_max = r1$fixed[4,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

adjustmentSets(
x = DAG_dry,
exposure = "TA_ngs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
)       # { P_ngs_t, SW_ngs_t, VPD_ngs_t }  (use the last one)

adjustmentSets(
x = DAG_dry,
exposure = "P_ngs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
)       # { SW_ngs_t, TA_ngs_t, VPD_ngs_t }  (use the last one)

#-------------------------------------------------------------------------------------

adjustmentSets(
x = DAG_dry,
exposure = "TA_gs_t",
outcome = "VPD_gs_t",
type = c("minimal"),
effect = c("direct")
) # { SW_gs_t }
r1 <- summary(brm(data=data_dry, VPD_gs_t ~ TA_gs_t + SW_gs_t + (1|IGBP) + (1|site_ID), iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))  
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[3], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[3,1], es_min = r1$fixed[3,3], es_max = r1$fixed[3,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

adjustmentSets(
x = DAG_dry,
exposure = "SW_gs_t",
outcome = "VPD_gs_t",
type = c("minimal"),
effect = c("direct")
) # { TA_gs_t }  use the above equation

#
adjustmentSets(
x = DAG_dry,
exposure = "P_gs_t",
outcome = "VPD_gs_t",
type = c("minimal"),
effect = c("direct")
) # { } 
r1 <- summary(brm(data=data_dry, VPD_gs_t ~ P_gs_t + (1|IGBP) + (1|site_ID), iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))  
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

#
adjustmentSets(
x = DAG_dry,
exposure = "TA_ngs_t",
outcome = "VPD_ngs_t",
type = c("minimal"),
effect = c("direct")
) # { SW_ngs_t }
r1 <- summary(brm(data=data_dry, VPD_ngs_t ~ TA_ngs_t + SW_ngs_t + (1|IGBP) + (1|site_ID), iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))  
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

adjustmentSets(
x = DAG_dry,
exposure = "P_ngs_t",
outcome = "VPD_ngs_t",
type = c("minimal"),
effect = c("direct")
) # {}
r1 <- summary(brm(data=data_dry, VPD_ngs_t ~ P_ngs_t + (1|IGBP) + (1|site_ID), iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))  
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_dry,
exposure = "SW_ngs_t",
outcome = "VPD_ngs_t",
type = c("minimal"),
effect = c("direct")
) # { TA_ngs_t }
r1 <- summary(brm(data=data_dry, VPD_ngs_t ~ SW_ngs_t + TA_ngs_t + (1|IGBP) + (1|site_ID), iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))  
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_dry,
exposure = "SW_ngs_t",
outcome = "TA_ngs_t",
type = c("minimal"),
effect = c("direct")
) # { }
r1 <- summary(brm(data=data_dry, TA_ngs_t ~ SW_ngs_t + (1|IGBP) + (1|site_ID), iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))  
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_dry,
exposure = "SW_gs_t",
outcome = "TA_gs_t",
type = c("minimal"),
effect = c("direct")
) # { }
r1 <- summary(brm(data=data_dry, TA_gs_t ~ SW_gs_t + (1|IGBP) + (1|site_ID), iter=2000, prior = priors, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))  
df <- data.frame(climate_veg = 'dry', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


#------------------------------------------------------------------------------------------------
#--------------------calculate total effect size of each driver----------------------------------
adjustmentSets(
x = DAG_dry,
exposure = "VPD_ngs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
)  # { P_ngs_t, SW_ngs_t, TA_ngs_t }
r1 <- summary(brm(data=data_dry, NEE_trend ~ VPD_ngs_t + P_ngs_t + SW_ngs_t + TA_ngs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1

df <- data.frame(climate_veg = 'dry', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)


adjustmentSets(
x = DAG_dry,
exposure = "TA_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
) # { Height, SW_gs_t }
r1 <- summary(brm(data=data_dry, NEE_trend ~ TA_gs_t + Height + SW_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1
df <- data.frame(climate_veg = 'dry', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)


adjustmentSets(
x = DAG_dry,
exposure = "P_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
)  # { }
r1 <- summary(brm(data=data_dry, NEE_trend ~ P_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1

df <- data.frame(climate_veg = 'dry', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)


adjustmentSets(
x = DAG_dry,
exposure = "SW_ngs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
)  # {  }
r1 <- summary(brm(data=data_dry, NEE_trend ~ SW_ngs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1

df <- data.frame(climate_veg = 'dry', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)


adjustmentSets(
x = DAG_dry,
exposure = "Height",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
)  # {}
r1 <- summary(brm(data=data_dry, NEE_trend ~ Height + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1

df <- data.frame(climate_veg = 'dry', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)

adjustmentSets(
x = DAG_dry,
exposure = "P_ngs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
) # {  }
r1 <- summary(brm(data=data_dry, NEE_trend ~ P_ngs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1

df <- data.frame(climate_veg = 'dry', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)


adjustmentSets(
x = DAG_dry,
exposure = "TA_ngs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
)  # { SW_ngs_t }
r1 <- summary(brm(data=data_dry, NEE_trend ~ TA_ngs_t + SW_ngs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1

df <- data.frame(climate_veg = 'dry', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)



adjustmentSets(
x = DAG_dry,
exposure = "SW_gs_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
)  # {  }
summary(brm(data=data_dry, NEE_trend ~ SW_gs_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))

#----------------------------------------------------------------------
# Precipitation in non-growing season; Air temperature in growing season. 
# this makes lots of sense now!
ggplot(data=data_dry, aes(x=P_gs_t, y=NEE_trend)) + 
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor(color='purple')

ggplot(data=data_dry, aes(x=VPD_ngs_t, y=NEE_trend)) + 
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor(color='purple')

ggplot(data=data_dry, aes(x=P_ngs_t, y=NEE_trend)) + 
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor(color='purple')


```

```{r wet warm climate}
DAG_wet <- dagitty("dag {
  TA_t -> LE_t <- P_t
  TA_t -> NEE_trend
  P_t -> NEE_trend
  LE_t -> NEE_trend
  Height -> NEE_trend
  Height -> LE_t
  SW_t -> NEE_trend
  SW_t -> TA_t
  SW_t -> LE_t
  P_t -> SW_t
}")
plot(graphLayout(DAG_wet))


data_wet <- data %>% 
  filter(category == "wet") %>% 
  dplyr::select(-c("category", "TA_gs_t", "P_gs_t", "SW_gs_t", "LE_gs_t", 
            "TA_ngs_t", "P_ngs_t", "LE_ngs_t", "Age")) # %>% filter(!is.na(CO2_t))

data_wet_DAG <- data_wet %>% dplyr::select(-c("IGBP", "site_ID"))

r <- localTests(x = DAG_wet, data=data_wet_DAG, type='cis', abbreviate.names = F)
plotLocalTestResults(r)
print(subset(r, p.value < 0.05))

summary(aov(data=data_wet, NEE_trend ~ IGBP)) # p = 0.169 # do not differentiate vegetation. 
#-------------------------------------------------------------------------------------
#----calculate direct effect
# scale all the variables using Z score
for (i in 1:ncol(data_wet)) {
  if (!names(data_wet)[i] %in% c('IGBP', 'site_ID')) {
    data_wet[, i] <- scale(data_wet[, i])
  }
}

adjustmentSets(
x = DAG_wet,
exposure = "LE_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
)  # { Height, P_t, SW_t, TA_t }

priors <- c(
  prior(normal(0.5, 0.5), class = "sd", lb = 0),  # Stronger prior for group-level SDs
  prior(normal(0.5, 0.1), class = "sigma", lb = 0)  # For residual error, this prior is confident 
)
r1 <- summary(brm(data=data_wet, NEE_trend ~ LE_t + P_t + TA_t + SW_t + Height + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.95, max_treedepth = 20), backend = "cmdstanr"))
for (i in 2:6) {
  df <- data.frame(climate_veg = 'wet-warm', 
                 link_name = paste0(rownames(r1$fixed)[i], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[i,1], es_min = r1$fixed[i,3], es_max = r1$fixed[i,4],
                 formula = as.character(formula(r1)[1]))
  df_direct_effect <- rbind(df_direct_effect, df)
}


adjustmentSets(
x = DAG_wet,
exposure = "P_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
)  # { Height, LE_t, SW_t, TA_t }       use the above equation

adjustmentSets(
x = DAG_wet,
exposure = "TA_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
)  # { Height, LE_t, SW_t, P_t }  use the above equation

adjustmentSets(
x = DAG_wet,
exposure = "SW_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
) # { Height, LE_t, P_t, TA_t }  use the above equation

adjustmentSets(
x = DAG_wet,
exposure = "Height",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("direct")
)  # {LE_t, P_t, SW_t, TA_t }  use the above equation
#----------------------------------------------------

adjustmentSets(
x = DAG_wet,
exposure = "P_t",
outcome = "LE_t",
type = c("minimal"),
effect = c("direct")
)  # {SW_t}

r1 <- summary(brm(data=data_wet, LE_t ~ P_t + SW_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet-warm', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

adjustmentSets(
x = DAG_wet,
exposure = "SW_t",
outcome = "LE_t",
type = c("minimal"),
effect = c("direct")
)  # {P_t, TA_t }
r1 <- summary(brm(data=data_wet, LE_t ~ SW_t + P_t + TA_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet-warm', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

adjustmentSets(
x = DAG_wet,
exposure = "TA_t",
outcome = "LE_t",
type = c("minimal"),
effect = c("direct")
)  # { SW_t }

r1 <- summary(brm(data=data_wet, LE_t ~ TA_t + SW_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet-warm', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

adjustmentSets(
x = DAG_wet,
exposure = "P_t",
outcome = "SW_t",
type = c("minimal"),
effect = c("direct")
) # {}
r1 <- summary(brm(data=data_wet, SW_t ~ P_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet-warm', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)


adjustmentSets(
x = DAG_wet,
exposure = "SW_t",
outcome = "TA_t",
type = c("minimal"),
effect = c("direct")
) # {}
r1 <- summary(brm(data=data_wet, TA_t ~ SW_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet-warm', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

adjustmentSets(
x = DAG_wet,
exposure = "Height",
outcome = "LE_t",
type = c("minimal"),
effect = c("direct")
)
r1 <- summary(brm(data=data_wet, LE_t ~ Height + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
df <- data.frame(climate_veg = 'wet-warm', 
                 link_name = paste0(rownames(r1$fixed)[2], '->', as.character(formula(r1)[4])), 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4],
                 formula = as.character(formula(r1)[1]))
df_direct_effect <- rbind(df_direct_effect, df)

#------------------------------------------------------------------------------------------------
#--------------------calculate total effect size of each driver----------------------------------
adjustmentSets(
x = DAG_wet,
exposure = "SW_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
) # {P_t}
r1 <- summary(brm(data=data_wet, NEE_trend ~ SW_t + P_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1
df <- data.frame(climate_veg = 'wet-warm', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)


adjustmentSets(
x = DAG_wet,
exposure = "LE_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
) # {Height, P_t, SW_t, TA_t}
r1 <- summary(brm(data=data_wet, NEE_trend ~ LE_t + Height + P_t + SW_t + TA_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1
df <- data.frame(climate_veg = 'wet-warm', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)


adjustmentSets(
x = DAG_wet,
exposure = "P_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
) # {}
r1 <- summary(brm(data=data_wet, NEE_trend ~ P_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1
df <- data.frame(climate_veg = 'wet-warm', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)


adjustmentSets(
x = DAG_wet,
exposure = "TA_t",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
) # { SW_t }
r1 <- summary(brm(data=data_wet, NEE_trend ~ TA_t + SW_t + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1
df <- data.frame(climate_veg = 'wet-warm', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)


adjustmentSets(
x = DAG_wet,
exposure = "Height",
outcome = "NEE_trend",
type = c("minimal"),
effect = c("total")
) # { }
r1 <- summary(brm(data=data_wet, NEE_trend ~ Height + (1|IGBP) + (1|site_ID), prior=priors, iter=2000, control = list(step_size = 0.01, adapt_delta = 0.99, max_treedepth = 20), backend = "cmdstanr"))
r1
df <- data.frame(climate_veg = 'wet-warm', var_name = rownames(r1$fixed)[2], 
                 es_mean = r1$fixed[2,1], es_min = r1$fixed[2,3], es_max = r1$fixed[2,4])
df_total_effect <- rbind(df_total_effect, df)


#-------------------------------------------------------------------------------
ggplot(data=data_wet, aes(x=LE_t, y=NEE_trend)) + 
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor(color='purple')

ggplot(data=data_wet, aes(x=SW_t, y=NEE_trend)) + 
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor(color='purple')

ggplot(data=data_wet, aes(x=P_t, y=NEE_trend)) + 
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor(color='purple')

ggplot(data=data_wet, aes(x=P_t, y=SW_t)) + 
  geom_point() +
  geom_smooth(method = lm) +
  stat_cor(color='purple')

write.csv(row.names = F, df_total_effect, 'data/total_effect_NEE_trend_driver_sen.csv')
write.csv(row.names = F, df_direct_effect, 'data/direct_effect_NEE_trend_driver_sen.csv')


```

```{r look at driver trends}
# cold evergreen forests
# growing season length is reducing. 
data %>% 
  filter(category == "cold") %>% 
  filter(IGBP %in% c('ENF', 'EBF')) %>%
  ggplot(aes(y=Lgs_t)) +
  geom_boxplot()

# P stays the same mostly
data %>% 
  filter(category == "cold") %>% 
  filter(IGBP %in% c('ENF', 'EBF')) %>%
  ggplot(aes(y=P_gs_t)) +
  geom_boxplot()  

#---------cold DBF and MF forests
# LE is increasing. 
data %>% 
  filter(category == "cold") %>% 
  filter(IGBP %in% c('DBF', 'MF')) %>%
  ggplot(aes(y=LE_gs_t)) +
  geom_boxplot()

#---------cold nonforests
# P_gs_t increased a lot. 
data %>% 
  filter(category == "cold") %>% 
  filter(!IGBP %in% c('ENF', 'EBF', 'DBF', 'MF')) %>%
  ggplot(aes(y=P_gs_t)) +
  geom_boxplot()


#---------dry climate; two layers of factors are at play; therefore strong carbon sequestration. 
# growing season P increased a lot
data %>% 
  filter(category == "dry") %>% 
  ggplot(aes(y=P_gs_t)) +
  geom_boxplot()

# VPD non-growing season increase a lot; good for dryland carbon sequestration.
# less carbon is lost in non-growing season. 
data %>% 
  filter(category == "dry") %>% 
  ggplot(aes(y=VPD_ngs_t)) +
  geom_boxplot()

#---------wet climate
data %>% 
  filter(category == "wet") %>% 
  ggplot(aes(y=SW_t)) +
  geom_boxplot()

data %>% 
  filter(category == "wet") %>% 
  ggplot(aes(y=P_t)) +
  geom_boxplot()

```



```{r NEE trends vary with climate and vegetation classes}
summary(aov(data=data, NEE_trend ~ IGBP + category))

summary(lm(data=data, NEE_trend ~ category))

data_cold <- data %>% filter(category=='cold')
summary(aov(data = data_cold, NEE_trend ~ IGBP))
summary(lm(data = data_cold, NEE_trend ~ IGBP))

ggplot(data=data_cold, aes(y=NEE_trend, x=IGBP)) + 
  geom_boxplot()

ggplot(data=data, aes(y=NEE_trend, x=category)) + 
  geom_boxplot()


```




